{% extends 'base.html' %}
{% load widget_tweaks %}
{% load my_filters %}
{% load mathfilters %}
{% block mobilnik_script %}
    <script type='text/javascript'>
        function DemoButton(jwt_value, key) {
            runDemoButton = document.getElementById('mobilnik_button');
            mobilnik.buy({
                jwt: jwt_value,
                key: key,
                success: function (e) {
                    console.log(e);
                    alert(a);
                },
                error: function (e) {
                    console.log(e);
                    alert(e);
                }
            });
            return false;
        }
    </script>
{% endblock %}
{% block content %}
    <section class="personal-area">
        <div class="uk-container-expand uk-container">
            <div class="uk-grid uk-grid-small" uk-grid="">
                <div class="uk-width-expand@m">
                    <div class="uk-card-default uk-card-body ">
                        {% has_transaction request.user as user_transactions %}
                        <h1>ЗАКАЗАТЬ ТАРИФ</h1>
                        <h1 class="uk-text-danger">В данный момент идут технические работы связанные с электронными
                            кошельками</h1>
                        {#                        {% if not user_transactions %}#}
                        {#                            <div class="table uk-width-1-1 uk-overflow-auto">#}
                        {#                                <table class="uk-table uk-table-small uk-table-divider uk-table-hover uk-table-middle uk-margin">#}
                        {#                                    <thead>#}
                        {#                                    <tr>#}
                        {#                                        <th>Спонсор</th>#}
                        {#                                        <th>Уровень спонсора</th>#}
                        {#                                        <th>Контакты</th>#}
                        {#                                        <th>Мобильник-кошелек</th>#}
                        {#                                        <th>Сумма</th>#}
                        {#                                        <th>ID транзакции для спонсора</th>#}
                        {#                                        <th>Отправить запрос</th>#}
                        {#                                    </tr>#}
                        {#                                    </thead>#}
                        {#                                    <tbody>#}
                        {#                                    {% if request.user.level %}#}
                        {#                                        {% get_parent_user request.user as parent %}#}
                        {#                                        <tr>#}
                        {#                                            <form action="{% url 'transaction' %}"#}
                        {#                                                  id="transaction_form_1" method="POST">#}
                        {#                                                {% csrf_token %}#}
                        {#                                                <td>{{ parent }}</td>#}
                        {#                                                <td>{{ parent.level }}</td>#}
                        {#                                                <td>{{ parent.phone }}</td>#}
                        {#                                                <td>{{ parent.mobilnik }}</td>#}
                        {#                                                {% if request.user.level %}#}
                        {#                                                    <td>{{ request.user.level.get_highest_product.price }}#}
                        {#                                                        сом#}
                        {#                                                    </td>#}
                        {#                                                {% else %}#}
                        {#                                                    <td>{{ products.first.price }} сом</td>#}
                        {#                                                {% endif %}#}
                        {#                                                <td>#}
                        {#                                                    <input type="hidden" name="handler"#}
                        {#                                                           value={{ request.user.pk }}>#}
                        {#                                                    {% if request.user.level %}#}
                        {#                                                        <input type="hidden" name="product"#}
                        {#                                                               value={{ request.user.level.get_highest_product.pk }}>#}
                        {#                                                    {% else %}#}
                        {#                                                        <input type="hidden" name="product"#}
                        {#                                                               value={{ products.first.pk }}>#}
                        {#                                                    {% endif %}#}
                        {#                                                    {% render_field transaction_form.key_for_user class+='uk-input' %}#}
                        {#                                                    <input type="hidden" name="used_by" value={{ parent.pk }}>#}
                        {#                                                </td>#}
                        {#                                                <td>#}
                        {#                                                    {% render_field transaction_form.key_for_admin class+='uk-input' %}#}
                        {#                                                </td>#}
                        {#                                                <td>#}
                        {#                                                    <a href="#transaction_form_1"#}
                        {#                                                       class="send-form uk-button uk-button-primary">Отправить</a>#}
                        {#                                                </td>#}
                        {#                                            </form>#}
                        {#                                        </tr>#}
                        {#                                    {% else %}#}
                        {#                                        <tr>#}
                        {#                                            <form action="{% url 'transaction' %}"#}
                        {#                                                  id="transaction_form_{{ forloop.counter }}" method="POST">#}
                        {#                                                {% csrf_token %}#}
                        {#                                                <td>{{ request.user.get_parent }}</td>#}
                        {#                                                <td>{{ request.user.get_parent.level }}</td>#}
                        {#                                                <td>{{ request.user.get_parent.phone }}</td>#}
                        {#                                                <td>{{ request.user.get_parent.mobilnik }}</td>#}
                        {#                                                {% if request.user.level %}#}
                        {#                                                    <td>{{ request.user.level.get_highest_product.price }}#}
                        {#                                                        сом#}
                        {#                                                    </td>#}
                        {#                                                {% else %}#}
                        {#                                                    <td>{{ products.first.price }} сом</td>#}
                        {#                                                {% endif %}#}
                        {#                                                <td>#}
                        {#                                                    <input type="hidden" name="handler"#}
                        {#                                                           value={{ request.user.pk }}>#}
                        {#                                                    {% if request.user.level %}#}
                        {#                                                        <input type="hidden" name="product"#}
                        {#                                                               value={{ request.user.level.get_highest_product.pk }}>#}
                        {#                                                    {% else %}#}
                        {#                                                        <input type="hidden" name="product"#}
                        {#                                                               value={{ products.first.pk }}>#}
                        {#                                                    {% endif %}#}
                        {#                                                    {% render_field transaction_form.key_for_user class+='uk-input' %}#}
                        {#                                                    <input type="hidden" name="used_by"#}
                        {#                                                           value={{ request.user.get_parent.pk }}>#}
                        {#                                                </td>#}
                        {#                                                <td>#}
                        {#                                                    {% render_field transaction_form.key_for_admin class+='uk-input' %}#}
                        {#                                                </td>#}
                        {#                                                <td>#}
                        {#                                                    <a href="#transaction_form_{{ forloop.counter }}"#}
                        {#                                                       class="send-form uk-button uk-button-primary">Отправить</a>#}
                        {#                                                </td>#}
                        {#                                            </form>#}
                        {#                                        </tr>#}
                        {#                                    {% endif %}#}
                        {#                                </table>#}
                        {#                            </div>#}
                        {#                            {% if request.user.level %}#}
                        {#                                <div class="uk-placeholder uk-margin-medium">#}
                        {#                                    <p>Сейчас вы можете заказать#}
                        {#                                        тариф: {{ request.user.level.get_highest_product }}.</p>#}
                        {#                                    <p>Для заказа тарифа совершите перевод на#}
                        {#                                        сумму:#}
                        {#                                        {{ request.user.level.get_highest_product.price |add:request.user.level.get_highest_product.price1 }}#}
                        {#                                        сом через платежную систему mobilnik.kg на вышеуказанный номер.</p>#}
                        {#                                    <p>В комментарии к переводу укажите: От {{ request.user }}, Newlife</p>#}
                        {#                                    <p>После совершения перевода, в mobilnik-кошельке в верхнем правом углу#}
                        {#                                        переходим в#}
                        {#                                        раздел#}
                        {#                                        "История".</p>#}
                        {#                                        <p>Далее в левом блоке выбираем период отчетов "Сегодня".</p>#}
                        {#                                    <p>Далее копируем и вставляем ID транзакцию перевода и нажимаем "Заказать#}
                        {#                                        тариф"</p>#}
                        {#                                    <p>Ваш спонсор получит уведомление о покупке тарифа, зайдет в свой#}
                        {#                                        mobilnik-кошелек,#}
                        {#                                        если#}
                        {#                                        платеж поступил на его счет, то сразу подтвердит Ваш заказ.</p>#}
                        {#                                </div>#}
                        {#                            {% else %}#}
                        {#                                <div class="uk-placeholder uk-margin-medium">#}
                        {#                                    <p>У вас пока нет тарифа, вы можете приобрести его у вашего спонсора</p>#}
                        {#                                    <p>Для заказа тарифа совершите перевод на сумму: {{ products.first.price }}#}
                        {#                                        сом через платежную#}
                        {#                                        систему#}
                        {#                                        mobilnik на вышеуказанный номер.</p>#}
                        {#                                    <p>В комментарии к переводу укажите: От {{ request.user }}, Newlife</p>#}
                        {#                                    <p>После совершения перевода, в mobilnik-кошельке в верхнем правом углу#}
                        {#                                        переходим в#}
                        {#                                        раздел#}
                        {#                                        "История".</p>#}
                        {#                                        <p>Далее в левом блоке выбираем период отчетов "Сегодня".</p>#}
                        {#                                    <p>Далее копируем и вставляем ID транзакцию перевода и нажимаем#}
                        {#                                        "Отправить"</p>#}
                        {#                                    <p>Ваш спонсор получит уведомление о покупке тарифа, зайдет в свой#}
                        {#                                        mobilnik-кошелек,#}
                        {#                                        если#}
                        {#                                        платеж поступил на его счет, то сразу подтвердит Ваш заказ.</p>#}
                        {#                                </div>#}
                        {#                            {% endif %}#}
                        {#                        {% else %}#}
                        {#                            <div class="uk-overflow-auto">#}
                        {#                                {% if not user_transactions.is_confirmed_by_user %}#}
                        {#                                    <div class="uk-placeholder uk-text-center uk-text-success">#}
                        {#                                        <legend class="uk-legend">#}
                        {#                                            Ваш запрос еще обрабатывается!#}
                        {#                                        </legend>#}
                        {#                                    </div>#}
                        {#                                {% elif not user_transactions.is_confirmed_by_admin %}#}
                        {#                                    <div class="uk-overflow-auto uk-placeholder uk-text-center">#}
                        {#                                        <div class="uk-text-success">#}
                        {#                                            <legend class="uk-legend uk-margin">#}
                        {#                                                Чтобы получить следующий тариф, вам нужно активировать продукт!#}
                        {#                                            </legend>#}
                        {#                                        </div>#}
                        {#                                        <a href="#" class="uk-button uk-button-primary" id="mobilnik_button"#}
                        {#                                           data-token=""#}
                        {#                                           data-seller-id="">АКТИВИРОВАТЬ#}
                        {#                                            ПРОДУКТ</a>#}
                        {#                                    </div>#}
                        {#                                {% elif request.user.level == products.last.level %}#}
                        {#                                    <div class="uk-placeholder uk-margin medium uk-text-center">#}
                        {#                                        <p>Вы купили самый последний тариф, можете наслаждаться и зарабатывать#}
                        {#                                            деньги</p>#}
                        {#                                        <p>Вероятно скоро появится тариф, на уровень выше вашего, и вы сможете его#}
                        {#                                            приобрести</p>#}
                        {#                                    </div>#}
                        {#                                {% endif %}#}
                        {#                            </div>#}
                        {##}
                        {#                        {% endif %}#}
                    </div>
                </div>
                {% include 'partials/profile-sidebar.html' %}
            </div>
        </div>
    </section>
{% endblock %}
{% block custom_scripts %}
    <script src="https://acquiring.mobilnik.kg/static/js/acquiring.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('.send-form').on('click', function (e) {
                e.preventDefault();
                var form = $($(this).attr("href"));
                $.ajax({
                    url: $(form).attr('action'),
                    data: $(form).serialize(),
                    method: 'POST',
                    datatype: 'JSON',
                    success: function (response) {
                        if (response.success) {
                            UIkit.notification(response.message, 'success');
                            setTimeout(function () {
                                window.location = window.location.href;
                            }, 500)
                        }
                        else {
                            UIkit.notification.closeAll();
                            UIkit.notification(response.message, 'danger');
                        }
                    }
                })
            });
            {% has_transaction request.user as user_transactions %}
            {% if user_transactions %}
                $.ajax({
                    url: '{% url 'mobilnik' %}',
                    method: 'POST',
                    data: {'transaction_id':{{ user_transactions.pk }}},
                    success: function (response) {
                        console.log(response)
                        $('#mobilnik_button').attr('data-token', response.token);
                        $('#mobilnik_button').attr('data-seller-id', response.seller_id)
                    },
                    error: function (response) {
                        console.log(response)
                    }
                });
                $('#mobilnik_button').on('click', function (e) {
                    e.preventDefault();
                    DemoButton($(this).attr('data-token'), $(this).attr('data-seller-id'))
                })
            {% endif %}
        });
    </script>
{% endblock %}